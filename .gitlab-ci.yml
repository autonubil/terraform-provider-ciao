image: docker.autonubil.net/shared/magarac:latest

cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
        - gocache
        - .sonar/cache
        - app/

variables:
    BASENAME: terraform-provider-ciao

stages:
    - validate
    - build

sonar:
    stage: validate
    script:
        - mkdir -p /root/.sonar/cache
        - sonar-scanner -Dsonar.projectKey=$CI_PROJECT_NAME -Dsonar.sources=. -Dsonar.login=$SONAR_TOKEN -Duser.home=/root/ -Dsonar.exclusions="client/**, models/**" || true
        - ls -al /root/.sonar/

build:
    stage: build
    script: |
        export ROOT=$(pwd)
        mkdir -p app/
        mkdir -p /root/gocache
        ls -alh
        go get .
        GOCACHE=${ROOT}/gocache CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -ldflags "-s -w -linkmode=external -v -X main.Version=${CI_COMMIT_REF_NAME} -X main.BuildDate=$(date --iso-8601=seconds) -X main.Commit=$CI_COMMIT_SHA -s" -a -v -o ${ROOT}/${BASENAME} main.go
        upx ${ROOT}/${BASENAME}
        nexus_publish_artifact.sh ${ROOT}/${BASENAME} terraform/linux/amd64/${BASENAME}
    artifacts:
      paths:
      - ${BASENAME}
    only:
      - master


build_linux_release:
    stage: build
    script: |
        export ROOT=$(pwd)
        mkdir -p app/
        mkdir -p /root/gocache
        ls -alh
        go get .
        GOCACHE=${ROOT}/gocache CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -ldflags "-s -w -linkmode=external -v -X main.Version=${CI_COMMIT_REF_NAME} -X main.BuildDate=$(date --iso-8601=seconds) -X main.Commit=$CI_COMMIT_SHA -s" -a -v -o ${ROOT}/${BASENAME}_${CI_COMMIT_REF_NAME} main.go
        upx ${ROOT}/${BASENAME}_${CI_COMMIT_REF_NAME}
        nexus_publish_artifact.sh ${ROOT}/${BASENAME}_${CI_COMMIT_REF_NAME} terraform/${BASENAME}/linux/x86/${BASENAME}_${CI_COMMIT_REF_NAME}
    artifacts:
      paths:
      - ${BASENAME}_${CI_COMMIT_REF_NAME}
    only:
        - tags


build_windows_release:
    stage: build
    script: |
        export ROOT=$(pwd)
        mkdir -p app/
        mkdir -p /root/gocache
        ls -alh
        go get .
        GOCACHE=${ROOT}/gocache CGO_ENABLED=1 GOOS=windows GOARCH=amd64 CXX_FOR_TARGET=i686-w64-mingw32-g++ CC_FOR_TARGET=i686-w64-mingw32-gcc go build -ldflags "-s -w -linkmode=external -v -X main.Version=${CI_COMMIT_REF_NAME} -X main.BuildDate=$(date --iso-8601=seconds) -X main.Commit=$CI_COMMIT_SHA -s" -a -v -o ${ROOT}/${BASENAME}_${CI_COMMIT_REF_NAME}.exe main.go
        nexus_publish_artifact.sh ${ROOT}/${BASENAME}_${CI_COMMIT_REF_NAME} terraform/${BASENAME}/windows/amd64/${BASENAME}_${CI_COMMIT_REF_NAME}
    artifacts:
      paths:
      - ${BASENAME}_${CI_COMMIT_REF_NAME}
    only:
        - tags
